@page "/analytics"
@using Atlas.Domain.ValueObjects
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5" Class="mb-4" Style="font-weight: 600; color: #e6edf3;">Cost Analytics</MudText>

<!-- Period Selector & Total Cost Display -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12" md="6">
        <MudButtonGroup Variant="Variant.Outlined" Color="Color.Default">
            <MudButton @onclick="() => SelectPeriod(7)" Variant="@(SelectedDays == 7 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 7 ? Color.Primary : Color.Default)">7 Days</MudButton>
            <MudButton @onclick="() => SelectPeriod(30)" Variant="@(SelectedDays == 30 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 30 ? Color.Primary : Color.Default)">30 Days</MudButton>
            <MudButton @onclick="() => SelectPeriod(90)" Variant="@(SelectedDays == 90 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 90 ? Color.Primary : Color.Default)">90 Days</MudButton>
        </MudButtonGroup>
    </MudItem>
    <MudItem xs="6" md="3">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); text-align: right; height: 100%;">
            <MudText Typo="Typo.caption" Style="color: #8b949e;">Total Cost</MudText>
            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #22c55e;">
                @if (AnalyticsData != null)
                {
                    <span>$@AnalyticsData.TotalCost.ToString("F2")</span>
                }
                else
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
            </MudText>
            <MudText Typo="Typo.caption" Style="color: #6b7280;">@SelectedDays day period</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" md="3">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); text-align: right; height: 100%;">
            <MudText Typo="Typo.caption" Style="color: #8b949e;">Daily Average</MudText>
            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #3b82f6;">
                @if (AnalyticsData != null && RoiData != null && RoiData.DaysTracked > 0)
                {
                    <span>$@((AnalyticsData.TotalCost / RoiData.DaysTracked).ToString("F2"))</span>
                }
                else if (AnalyticsData != null)
                {
                    <span>$@AnalyticsData.AverageDailyCost.ToString("F2")</span>
                }
                else
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
            </MudText>
            <MudText Typo="Typo.caption" Style="color: #6b7280;">per day</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Dashboard Operations & ROI -->
@if (RoiData != null)
{
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #1a1f2b 100%); border-radius: 12px; border: 1px solid rgba(59,130,246,0.15);">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Style="color: #3b82f6;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Dashboard Operations</MudText>
            </MudStack>

            <!-- Top: operation cost + daily avg -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Dashboard Operation Cost</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #f59e0b;">$@RoiData.DashboardOperationCost.ToString("F2")</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">@RoiData.DashboardPercent.ToString("F1")% of $@RoiData.TotalUserSpend.ToString("F2") total</MudText>
                </div>
                <div style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Daily Average</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #3b82f6;">$@RoiData.DailyAverageCost.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem; color: #6b7280;">/day</span></MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">across @RoiData.DaysTracked days</MudText>
                </div>
                <div style="@($"background: rgba({(RoiData.ModelTierSavings > 0 ? "34,197,94" : "59,130,246")},0.08); border: 1px solid rgba({(RoiData.ModelTierSavings > 0 ? "34,197,94" : "59,130,246")},0.2); border-radius: 10px; padding: 12px;")">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">
                        @(RoiData.ModelTierSavings > 0 ? "Saved" : "Could Save")
                    </MudText>
                    <MudText Typo="Typo.h5" Style="@($"font-weight: 700; color: {(RoiData.ModelTierSavings > 0 ? "#22c55e" : "#3b82f6")};")">
                        @if (RoiData.ModelTierSavings > 0)
                        {
                            <span>$@RoiData.ModelTierSavings.ToString("F2")</span>
                        }
                        else
                        {
                            <span>$@RoiData.PotentialMonthlySavings.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem; color: #6b7280;">/mo</span></span>
                        }
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">
                        @if (RoiData.DelegatedRequests > 0)
                        {
                            <span>@RoiData.DelegatedRequests requests delegated</span>
                        }
                        else
                        {
                            <span>by delegating to cheaper models</span>
                        }
                    </MudText>
                </div>
                <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Est. Total Savings</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #22c55e;">
                        $@((RoiData.ModelTierSavings + RoiData.PotentialMonthlySavings).ToString("F2"))
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">actual + projected monthly</MudText>
                </div>
            </div>

            <!-- Operation breakdown -->
            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">What the Dashboard Handles</MudText>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px;">
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.ListAlt" Size="Size.Small" Style="color: #3b82f6;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.ActivityLogCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Activity Logs</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Task" Size="Size.Small" Style="color: #a855f7;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.TaskCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Tasks Managed</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Style="color: #f59e0b;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.CredentialRequestCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Credential Requests</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Style="color: #22c55e;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.MessageRelayCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Messages Relayed</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" Size="Size.Small" Style="color: #06b6d4;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.MonitoringCheckCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Health Checks</MudText>
                </div>
            </div>

            @if (RoiData.ModelTierSavings > 0)
            {
                <MudAlert Severity="Severity.Success" Variant="Variant.Text" Dense="true" Class="mt-3" Style="background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.15);">
                    üí∞ <b>Saved $@RoiData.ModelTierSavings.ToString("F2")</b> by routing @RoiData.DelegatedRequests requests to cheaper models.
                    Projected: <b>$@RoiData.PotentialMonthlySavings.ToString("F2")/mo</b>.
                </MudAlert>
            }
            else if (RoiData.DelegatedRequests == 0 && RoiData.PotentialMonthlySavings > 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-3" Style="background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15);">
                    üí° Delegating background tasks to cheaper models could save ~<b>$@RoiData.PotentialMonthlySavings.ToString("F2")/mo</b>. The dashboard tracks this automatically.
                </MudAlert>
            }

            <!-- Cost Optimization Recommendations -->
            @if (AnalyticsData?.Recommendations != null && AnalyticsData.Recommendations.Count > 0)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2" Style="color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Cost Optimization</MudText>
                <MudStack Spacing="2">
                    @foreach (var rec in AnalyticsData.Recommendations)
                    {
                        var worthColor = rec.WorthinessPercent >= 80 ? "#22c55e" : rec.WorthinessPercent >= 60 ? "#f59e0b" : "#ef4444";
                        var worthLabel = rec.WorthinessPercent >= 80 ? "Recommended" : rec.WorthinessPercent >= 60 ? "Consider" : "Risky";
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 12px;">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
                                <MudIcon Icon="@(rec.Priority == 1 ? Icons.Material.Filled.Warning : Icons.Material.Filled.Lightbulb)"
                                         Size="Size.Small" Style="@($"color: {(rec.Priority == 1 ? "#f59e0b" : "#3b82f6")};")"/>
                                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3; flex: 1;">@rec.Title</MudText>
                                <MudText Typo="Typo.caption" Style="color: #22c55e; font-weight: 600;">~$@rec.EstimatedMonthlySavings.ToString("F2")/mo</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Style="color: #8b949e;" Class="mb-2">@rec.Description</MudText>

                            @if (!string.IsNullOrEmpty(rec.Tradeoff))
                            {
                                <div style="background: rgba(255,255,255,0.02); border-left: 3px solid @worthColor; border-radius: 0 6px 6px 0; padding: 8px 10px; margin-bottom: 8px;">
                                    <MudText Typo="Typo.caption" Style="color: #6b7280; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">‚öñÔ∏è Tradeoff</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #8b949e;">@rec.Tradeoff</MudText>
                                </div>
                            }

                            <!-- Worthiness gauge -->
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden;">
                                    <div style="@($"height: 100%; width: {rec.WorthinessPercent}%; background: {worthColor}; border-radius: 3px; transition: width 0.3s ease;")"></div>
                                </div>
                                <MudText Typo="Typo.caption" Style="@($"color: {worthColor}; font-weight: 700; white-space: nowrap; min-width: 100px; text-align: right;")">
                                    @rec.WorthinessPercent% @worthLabel
                                </MudText>
                            </MudStack>
                        </div>
                    }
                </MudStack>
            }
        </MudPaper>
    </MudItem>
</MudGrid>
}

<!-- Row 1: Daily Cost Chart -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-3" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-2 ml-1" Style="font-weight: 600; color: #e6edf3;">Daily Cost Trend</MudText>
            @if (DailyCostSeries != null && DailyCostSeries.Count > 0)
            {
                <MudChart ChartType="ChartType.Line" ChartSeries="@DailyCostSeries" XAxisLabels="@DailyCostLabels"
                          Width="100%" Height="400px"
                          ChartOptions="@(new ChartOptions { YAxisTicks = 5, LineStrokeWidth = 2 })" />
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 2: Cost by Project -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Cost by Project</MudText>
            @if (AnalyticsData?.CostByProject != null && AnalyticsData.CostByProject.Count > 0)
            {
                <MudStack Spacing="2">
                    @{ var maxCost = AnalyticsData.CostByProject.Max(p => p.TotalCost); }
                    @foreach (var project in AnalyticsData.CostByProject)
                    {
                        var pct = maxCost > 0 ? (double)(project.TotalCost / maxCost) * 100 : 0;
                        var totalPct = AnalyticsData.TotalCost > 0 ? (double)(project.TotalCost / AnalyticsData.TotalCost) * 100 : 0;
                        var barColor = GetProjectColor(project.Project);
                        <div style="cursor: pointer;" @onclick="() => ToggleProjectDetail(project.Project)">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
                                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: @(project.IsActive ? "#22c55e" : "#6b7280"); flex-shrink: 0;" title="@(project.IsActive ? "Active" : $"Inactive ‚Äî {project.DaysSinceLastActivity}d ago")"></span>
                                <MudText Typo="Typo.body2" Style="@($"font-weight: 600; color: {(project.IsActive ? "#e6edf3" : "#6b7280")}; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;")">
                                    @project.Project
                                </MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e; white-space: nowrap;">
                                    $@project.TotalCost.ToString("F2")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: #8b949e; white-space: nowrap; min-width: 40px; text-align: right;">
                                    @totalPct.ToString("F0")%
                                </MudText>
                            </MudStack>
                            <div style="height: 6px; background: rgba(255,255,255,0.04); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: @(pct.ToString("F1"))%; background: @(project.IsActive ? barColor : "#4b5563"); border-radius: 3px; transition: width 0.3s ease;"></div>
                            </div>
                            @if (_expandedProject == project.Project)
                            {
                                <MudStack Spacing="2" Class="mt-2" Style="padding-left: 16px;">
                                    <MudStack Row="true" Spacing="3">
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Api" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @project.RequestCount requests
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Input" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(project.TotalInputTokens) in
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Output" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(project.TotalOutputTokens) out
                                        </MudText>
                                    </MudStack>
                                    <MudStack Row="true" Spacing="3">
                                        <MudText Typo="Typo.caption" Style="@($"color: {(project.IsActive ? "#3b82f6" : "#6b7280")};")">
                                            @(project.IsActive ? "‚óè Active" : $"‚óã Inactive ({project.DaysSinceLastActivity}d)")
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            @project.DaysActive days tracked
                                        </MudText>
                                    </MudStack>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">7d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #3b82f6;">$@project.RollingAvg7Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                        <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">14d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #f59e0b;">$@project.RollingAvg14Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                        <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">30d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">$@project.RollingAvg30Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                    </div>
                                </MudStack>
                            }
                        </div>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No project data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 3: Cost by Model & Top Sessions -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Cost by Model</MudText>
            @if (ModelCostSeries != null && ModelCostSeries.Count > 0)
            {
                <MudChart ChartType="ChartType.Donut" ChartSeries="@ModelCostSeries" InputLabels="@ModelLabels"
                          Width="100%" Height="300px" />
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Top Sessions</MudText>
            @if (AnalyticsData?.TopSessions != null && AnalyticsData.TopSessions.Count > 0)
            {
                <MudStack Spacing="2">
                    @foreach (var session in AnalyticsData.TopSessions.Take(5))
                    {
                        <MudPaper Class="pa-3" Elevation="0" Style="background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudStack Style="flex: 1;">
                                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3;">@(session.SessionKey ?? "Unknown")</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #8b949e;">@session.RequestCount requests</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">$@session.TotalCost.ToString("F2")</MudText>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 3: Top Expensive Sessions Table -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Most Expensive Requests</MudText>
            @if (AnalyticsData?.TopSessions != null && AnalyticsData.TopSessions.Count > 0)
            {
                <MudDataGrid Items="@(AnalyticsData.TopSessions.AsQueryable())" Striped="true" Hover="true" Style="background: transparent;">
                    <Columns>
                        <PropertyColumn Property="x => x.SessionKey" Title="Session" />
                        <PropertyColumn Property="x => x.TaskCategory" Title="Category" />
                        <PropertyColumn Property="x => x.RequestCount" Title="Requests" />
                        <PropertyColumn Property="x => x.TotalCost" Title="Total Cost" Format="$0.00" />
                        <PropertyColumn Property="x => x.AverageCostPerRequest" Title="Avg Cost/Request" Format="$0.000000" />
                    </Columns>
                </MudDataGrid>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private CostAnalyticsSummary? AnalyticsData;
    private DashboardRoiSummary? RoiData;
    private int SelectedDays = 30;
    private List<ChartSeries> DailyCostSeries = new();
    private string[] DailyCostLabels = Array.Empty<string>();
    private List<ChartSeries> ModelCostSeries = new();
    private string[] ModelLabels = Array.Empty<string>();
    private string? _expandedProject;

    private static readonly string[] ProjectColors = { "#3b82f6", "#f59e0b", "#22c55e", "#a855f7", "#06b6d4", "#ef4444", "#ec4899", "#8b5cf6", "#14b8a6", "#f97316" };

    private string GetProjectColor(string project)
    {
        var idx = Math.Abs(project.GetHashCode()) % ProjectColors.Length;
        return ProjectColors[idx];
    }

    private string FormatTokens(int tokens)
    {
        if (tokens >= 1_000_000) return $"{tokens / 1_000_000.0:F1}M";
        if (tokens >= 1_000) return $"{tokens / 1_000.0:F0}k";
        return tokens.ToString();
    }

    private void ToggleProjectDetail(string project)
    {
        _expandedProject = _expandedProject == project ? null : project;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalyticsAsync();
    }

    private async Task SelectPeriod(int days)
    {
        SelectedDays = days;
        await LoadAnalyticsAsync();
    }

    private async Task LoadAnalyticsAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync($"/api/analytics/dashboard?days={SelectedDays}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                AnalyticsData = JsonSerializer.Deserialize<CostAnalyticsSummary>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                UpdateCharts();

            // Load ROI data
            var roiResponse = await HttpClient.GetAsync($"/api/analytics/roi?days={SelectedDays}");
            if (roiResponse.IsSuccessStatusCode)
            {
                var roiJson = await roiResponse.Content.ReadAsStringAsync();
                RoiData = JsonSerializer.Deserialize<DashboardRoiSummary>(roiJson, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            }
            else
            {
                Snackbar.Add("Failed to load analytics", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void UpdateCharts()
    {
        if (AnalyticsData == null) return;

        // Daily Cost Chart
        DailyCostSeries = new()
        {
            new ChartSeries
            {
                Name = "Daily Cost ($)",
                Data = AnalyticsData.DailyCosts.Select(d => (double)d.Cost).ToArray()
            }
        };
        DailyCostLabels = AnalyticsData.DailyCosts
            .Select(d => d.Date.ToString("MMM d"))
            .ToArray();

        // Model Cost Pie Chart
        if (AnalyticsData.CostByModel.Count > 0)
        {
            ModelCostSeries = new()
            {
                new ChartSeries
                {
                    Name = "Cost by Model",
                    Data = AnalyticsData.CostByModel.Select(m => (double)m.TotalCost).ToArray()
                }
            };
            ModelLabels = AnalyticsData.CostByModel.Select(m => m.Model).ToArray();
        }
    }
}
