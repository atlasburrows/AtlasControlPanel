@page "/analytics"
@using Atlas.Domain.ValueObjects
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudText Typo="Typo.h5" Class="mb-4" Style="font-weight: 600; color: #e6edf3;">Cost Analytics</MudText>

<!-- Period Selector & Total Cost Display -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12" md="6">
        <MudButtonGroup Variant="Variant.Outlined" Color="Color.Default">
            <MudButton @onclick="() => SelectPeriod(7)" Variant="@(SelectedDays == 7 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 7 ? Color.Primary : Color.Default)">7 Days</MudButton>
            <MudButton @onclick="() => SelectPeriod(30)" Variant="@(SelectedDays == 30 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 30 ? Color.Primary : Color.Default)">30 Days</MudButton>
            <MudButton @onclick="() => SelectPeriod(90)" Variant="@(SelectedDays == 90 ? Variant.Filled : Variant.Outlined)" Color="@(SelectedDays == 90 ? Color.Primary : Color.Default)">90 Days</MudButton>
        </MudButtonGroup>
    </MudItem>
    <MudItem xs="6" md="3">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); text-align: right; height: 100%;">
            <MudText Typo="Typo.caption" Style="color: #8b949e;">Total Cost</MudText>
            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #22c55e;">
                @if (AnalyticsData != null)
                {
                    <span>$@AnalyticsData.TotalCost.ToString("F2")</span>
                }
                else
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
            </MudText>
            <MudText Typo="Typo.caption" Style="color: #6b7280;">@SelectedDays day period</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" md="3">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); text-align: right; height: 100%;">
            <MudText Typo="Typo.caption" Style="color: #8b949e;">Daily Average</MudText>
            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #3b82f6;">
                @if (AnalyticsData != null && RoiData != null && RoiData.DaysTracked > 0)
                {
                    <span>$@((AnalyticsData.TotalCost / RoiData.DaysTracked).ToString("F2"))</span>
                }
                else if (AnalyticsData != null)
                {
                    <span>$@AnalyticsData.AverageDailyCost.ToString("F2")</span>
                }
                else
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
            </MudText>
            <MudText Typo="Typo.caption" Style="color: #6b7280;">per day</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Dashboard Operations & ROI -->
@if (RoiData != null)
{
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #1a1f2b 100%); border-radius: 12px; border: 1px solid rgba(59,130,246,0.15);">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Style="color: #3b82f6;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Dashboard Operations</MudText>
            </MudStack>

            <!-- Top: operation cost + daily avg -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Dashboard Operation Cost</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #f59e0b;">$@RoiData.DashboardOperationCost.ToString("F2")</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">@RoiData.DashboardPercent.ToString("F1")% of $@RoiData.TotalUserSpend.ToString("F2") total</MudText>
                </div>
                <div style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Daily Average</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #3b82f6;">$@RoiData.DailyAverageCost.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem; color: #6b7280;">/day</span></MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">across @RoiData.DaysTracked days</MudText>
                </div>
                <div style="@($"background: rgba({(RoiData.ModelTierSavings > 0 ? "34,197,94" : "59,130,246")},0.08); border: 1px solid rgba({(RoiData.ModelTierSavings > 0 ? "34,197,94" : "59,130,246")},0.2); border-radius: 10px; padding: 12px;")">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">
                        @(RoiData.ModelTierSavings > 0 ? "Saved" : "Could Save")
                    </MudText>
                    <MudText Typo="Typo.h5" Style="@($"font-weight: 700; color: {(RoiData.ModelTierSavings > 0 ? "#22c55e" : "#3b82f6")};")">
                        @if (RoiData.ModelTierSavings > 0)
                        {
                            <span>$@RoiData.ModelTierSavings.ToString("F2")</span>
                        }
                        else
                        {
                            <span>$@RoiData.PotentialMonthlySavings.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem; color: #6b7280;">/mo</span></span>
                        }
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">
                        @if (RoiData.DelegatedRequests > 0)
                        {
                            <span>@RoiData.DelegatedRequests requests delegated</span>
                        }
                        else
                        {
                            <span>by delegating to cheaper models</span>
                        }
                    </MudText>
                </div>
                <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px; padding: 12px;">
                    <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Est. Total Savings</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #22c55e;">
                        $@((RoiData.ModelTierSavings + RoiData.PotentialMonthlySavings).ToString("F2"))
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">actual + projected monthly</MudText>
                </div>
            </div>

            <!-- Operation breakdown -->
            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">What the Dashboard Handles</MudText>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px;">
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.ListAlt" Size="Size.Small" Style="color: #3b82f6;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.ActivityLogCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Activity Logs</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Task" Size="Size.Small" Style="color: #a855f7;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.TaskCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Tasks Managed</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Style="color: #f59e0b;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.CredentialRequestCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Credential Requests</MudText>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 10px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" Size="Size.Small" Style="color: #06b6d4;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 700; color: #e6edf3;">@RoiData.MonitoringCheckCount</MudText>
                    <MudText Typo="Typo.caption" Style="color: #6b7280;">Health Checks</MudText>
                </div>
            </div>

            @if (RoiData.ModelTierSavings > 0)
            {
                <MudAlert Severity="Severity.Success" Variant="Variant.Text" Dense="true" Class="mt-3" Style="background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.15);">
                    üí∞ <b>Saved $@RoiData.ModelTierSavings.ToString("F2")</b> by routing @RoiData.DelegatedRequests requests to cheaper models.
                    Projected: <b>$@RoiData.PotentialMonthlySavings.ToString("F2")/mo</b>.
                </MudAlert>
            }
            else if (RoiData.DelegatedRequests == 0 && RoiData.PotentialMonthlySavings > 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-3" Style="background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15);">
                    üí° Delegating background tasks to cheaper models could save ~<b>$@RoiData.PotentialMonthlySavings.ToString("F2")/mo</b>. The dashboard tracks this automatically.
                </MudAlert>
            }

        </MudPaper>
    </MudItem>
</MudGrid>
}

<!-- Cost Optimization ‚Äî Overall efficiency, separate from dashboard ops -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #1a1520 100%); border-radius: 12px; border: 1px solid rgba(245,158,11,0.15);">
            <div Class="mb-3">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.TipsAndUpdates" Style="color: #f59e0b;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Cost Optimization</MudText>
                </MudStack>
                <MudText Typo="Typo.caption" Style="color: #6b7280; margin-left: 32px;">Analyzes your overall usage</MudText>
            </div>

            @if (AnalyticsData?.Recommendations != null && AnalyticsData.Recommendations.Count > 0)
            {
                <MudStack Spacing="2">
                    @foreach (var rec in AnalyticsData.Recommendations)
                    {
                        var worthColor = rec.WorthinessPercent >= 80 ? "#22c55e" : rec.WorthinessPercent >= 60 ? "#f59e0b" : "#ef4444";
                        var worthLabel = rec.WorthinessPercent >= 80 ? "Recommended" : rec.WorthinessPercent >= 60 ? "Consider" : "Risky";
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; padding: 12px;">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
                                <MudIcon Icon="@(rec.Priority == 1 ? Icons.Material.Filled.Warning : Icons.Material.Filled.Lightbulb)"
                                         Size="Size.Small" Style="@($"color: {(rec.Priority == 1 ? "#f59e0b" : "#3b82f6")};")"/>
                                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3; flex: 1;">@rec.Title</MudText>
                                <MudText Typo="Typo.caption" Style="color: #22c55e; font-weight: 600;">~$@rec.EstimatedMonthlySavings.ToString("F2")/mo</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Style="color: #8b949e;" Class="mb-2">@rec.Description</MudText>

                            @if (!string.IsNullOrEmpty(rec.Tradeoff))
                            {
                                <div style="background: rgba(255,255,255,0.02); border-left: 3px solid @worthColor; border-radius: 0 6px 6px 0; padding: 8px 10px; margin-bottom: 8px;">
                                    <MudText Typo="Typo.caption" Style="color: #6b7280; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">‚öñÔ∏è Tradeoff</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #8b949e;">@rec.Tradeoff</MudText>
                                </div>
                            }

                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden;">
                                    <div style="@($"height: 100%; width: {rec.WorthinessPercent}%; background: {worthColor}; border-radius: 3px; transition: width 0.3s ease;")"></div>
                                </div>
                                <MudText Typo="Typo.caption" Style="@($"color: {worthColor}; font-weight: 700; white-space: nowrap;")">
                                    @rec.WorthinessPercent% @worthLabel
                                </MudText>
                                @if (!rec.ActionItems.StartsWith("‚úÖ"))
                                {
                                    <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success"
                                               Style="min-width: 60px; height: 28px; font-size: 0.7rem;"
                                               @onclick="() => ActionRecommendation(rec.Title, true)">Apply</MudButton>
                                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default"
                                               Style="min-width: 60px; height: 28px; font-size: 0.7rem; color: #6b7280;"
                                               @onclick="() => ActionRecommendation(rec.Title, false)">Reject</MudButton>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text" Style="font-size: 0.65rem;">Applied</MudChip>
                                }
                            </MudStack>
                        </div>
                    }
                </MudStack>
            }
            else
            {
                <div style="background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.15); border-radius: 10px; padding: 16px; text-align: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Verified" Style="color: #22c55e; font-size: 2rem;" />
                    <MudText Typo="Typo.body1" Style="font-weight: 600; color: #22c55e; margin-top: 4px;">Running at Maximum Efficiency</MudText>
                    <MudText Typo="Typo.caption" Style="color: #8b949e;">No further optimizations found. Your setup is cost-optimized.</MudText>
                </div>
            }

            <!-- Optimization History -->
            @if (OptHistory != null && OptHistory.Count > 0)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2" Style="color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                    History
                    @if (OptTotalSaved > 0)
                    {
                        <span style="color: #22c55e; margin-left: 8px;">üí∞ $@OptTotalSaved.ToString("F2") saved all-time</span>
                    }
                </MudText>
                <MudStack Spacing="1">
                    @foreach (var item in (_showAllHistory ? OptHistory : OptHistory.Take(5)))
                    {
                        var isApplied = item.Action == "applied";
                        var isExpanded = _expandedHistoryItem == item.RecommendationTitle;
                        var missedSavings = !isApplied && item.EstimatedMonthlySavings.HasValue
                            ? item.EstimatedMonthlySavings.Value / 30 * item.DaysSinceImplementation
                            : 0m;
                        <div style="background: rgba(255,255,255,0.02); border-radius: 8px; border-left: 3px solid @(isApplied ? "#22c55e" : "#ef4444"); padding: 8px 12px; cursor: pointer; transition: background 0.15s;"
                             @onclick="() => ToggleHistoryItem(item.RecommendationTitle)">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@(isApplied ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                         Size="Size.Small" Style="@($"color: {(isApplied ? "#22c55e" : "#ef4444")}; flex-shrink: 0;")" />
                                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @item.RecommendationTitle
                                </MudText>
                                @if (isApplied && item.ActualSavingsSinceImplementation > 0)
                                {
                                    <MudText Typo="Typo.caption" Style="color: #22c55e; font-weight: 700; white-space: nowrap;">+$@item.ActualSavingsSinceImplementation.ToString("F2")</MudText>
                                }
                                else if (item.EstimatedMonthlySavings.HasValue)
                                {
                                    <MudText Typo="Typo.caption" Style="@($"color: {(isApplied ? "#3b82f6" : "#ef4444")}; font-weight: 600; white-space: nowrap;")">$@item.EstimatedMonthlySavings.Value.ToString("F2")/mo</MudText>
                                }
                                <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                         Size="Size.Small" Style="color: #484f58; flex-shrink: 0;" />
                            </MudStack>
                            @if (isExpanded)
                            {
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.04);">
                                    @if (!string.IsNullOrEmpty(item.ActionDetails))
                                    {
                                        <MudText Typo="Typo.caption" Style="color: #8b949e; margin-bottom: 6px;">@item.ActionDetails</MudText>
                                    }
                                    <MudStack Row="true" Spacing="3" Style="flex-wrap: wrap;">
                                        <MudText Typo="Typo.caption" Style="@($"color: {(isApplied ? "#22c55e" : "#ef4444")}; font-size: 0.65rem;")">
                                            @(isApplied ? "‚úÖ" : "‚ùå") @(isApplied ? "Applied" : "Rejected") @(item.DaysSinceImplementation > 0 ? $"{item.DaysSinceImplementation}d ago" : "today")
                                        </MudText>
                                        @if (isApplied && item.EstimatedMonthlySavings.HasValue)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #3b82f6; font-size: 0.65rem;">üìä Est. $@item.EstimatedMonthlySavings.Value.ToString("F2")/mo</MudText>
                                        }
                                        @if (!isApplied && missedSavings > 0)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #f59e0b; font-size: 0.65rem;">‚ö†Ô∏è ~$@missedSavings.ToString("F2") missed</MudText>
                                        }
                                    </MudStack>
                                    @if (isApplied && item.ActualSavingsSinceImplementation > 0)
                                    {
                                        <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.15); border-radius: 6px; padding: 6px 10px; margin-top: 6px; display: inline-block;">
                                            <MudText Typo="Typo.caption" Style="color: #22c55e; font-weight: 700;">Saved $@item.ActualSavingsSinceImplementation.ToString("F2") so far</MudText>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </MudStack>
                @if (OptHistory.Count > 5)
                {
                    <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                               Style="margin-top: 8px; font-size: 0.75rem;"
                               @onclick="() => { _showAllHistory = !_showAllHistory; }">
                        @(_showAllHistory ? "Show Less" : $"See All ({OptHistory.Count})")
                    </MudButton>
                }
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 1: Daily Cost Chart -->
<MudGrid Spacing="3" Class="mb-2">
    <MudItem xs="12">
        <MudPaper Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); overflow: hidden; padding: 8px 0 0 0;">
            <MudText Typo="Typo.h6" Class="mb-0" Style="font-weight: 600; color: #e6edf3; font-size: 0.95rem; padding: 0 12px;">Daily Cost Trend</MudText>
            @if (DailyCostSeries != null && DailyCostSeries.Count > 0)
            {
                <div id="dailyCostChart" class="area-chart-wrap" style="height: 42vh; min-height: 250px;">
                <MudChart ChartType="ChartType.Line" ChartSeries="@DailyCostSeries" XAxisLabels="@DailyCostLabels"
                          Width="100%" Height="100%"
                          ChartOptions="@(new ChartOptions { YAxisTicks = 5, LineStrokeWidth = 2 })" />
                </div>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 2: Cost by Project -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Cost by Project</MudText>
            @if (AnalyticsData?.CostByProject != null && AnalyticsData.CostByProject.Count > 0)
            {
                <MudStack Spacing="2">
                    @{ var maxCost = AnalyticsData.CostByProject.Max(p => p.TotalCost); }
                    @foreach (var project in AnalyticsData.CostByProject)
                    {
                        var pct = maxCost > 0 ? (double)(project.TotalCost / maxCost) * 100 : 0;
                        var totalPct = AnalyticsData.TotalCost > 0 ? (double)(project.TotalCost / AnalyticsData.TotalCost) * 100 : 0;
                        var barColor = GetProjectColor(project.Project);
                        <div style="cursor: pointer;" @onclick="() => ToggleProjectDetail(project.Project)">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
                                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: @(project.IsActive ? "#22c55e" : "#6b7280"); flex-shrink: 0;" title="@(project.IsActive ? "Active" : $"Inactive ‚Äî {project.DaysSinceLastActivity}d ago")"></span>
                                <MudText Typo="Typo.body2" Style="@($"font-weight: 600; color: {(project.IsActive ? "#e6edf3" : "#6b7280")}; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;")">
                                    @project.Project
                                </MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e; white-space: nowrap;">
                                    $@project.TotalCost.ToString("F2")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: #8b949e; white-space: nowrap; min-width: 40px; text-align: right;">
                                    @totalPct.ToString("F0")%
                                </MudText>
                            </MudStack>
                            <div style="height: 6px; background: rgba(255,255,255,0.04); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: @(pct.ToString("F1"))%; background: @(project.IsActive ? barColor : "#4b5563"); border-radius: 3px; transition: width 0.3s ease;"></div>
                            </div>
                            @if (_expandedProject == project.Project)
                            {
                                <MudStack Spacing="2" Class="mt-2" Style="padding-left: 16px;">
                                    <MudStack Row="true" Spacing="3">
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Api" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @project.RequestCount requests
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Input" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(project.TotalInputTokens) in
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Output" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(project.TotalOutputTokens) out
                                        </MudText>
                                    </MudStack>
                                    <MudStack Row="true" Spacing="3">
                                        <MudText Typo="Typo.caption" Style="@($"color: {(project.IsActive ? "#3b82f6" : "#6b7280")};")">
                                            @(project.IsActive ? "‚óè Active" : $"‚óã Inactive ({project.DaysSinceLastActivity}d)")
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            @project.DaysActive days tracked
                                        </MudText>
                                    </MudStack>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">7d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #3b82f6;">$@project.RollingAvg7Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                        <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">14d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #f59e0b;">$@project.RollingAvg14Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                        <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">30d avg</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">$@project.RollingAvg30Day.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                    </div>
                                </MudStack>
                            }
                        </div>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No project data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 3: Cost by Model & Top Sessions -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Cost by Model</MudText>
            @if (ModelCostData != null && ModelCostData.Length > 0)
            {
                <MudChart ChartType="ChartType.Donut" InputData="@ModelCostData" InputLabels="@ModelLabels"
                          Width="100%" Height="300px" />
                <MudStack Spacing="1" Class="mt-3">
                    @for (var i = 0; i < ModelLabels.Length; i++)
                    {
                        var idx = i;
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: @GetChartColor(idx); flex-shrink: 0;"></span>
                            <MudText Typo="Typo.caption" Style="color: #c9d1d9; flex: 1;">@ModelLabels[idx]</MudText>
                            <MudText Typo="Typo.caption" Style="color: #22c55e; font-weight: 600;">$@ModelCostData[idx].ToString("F2")</MudText>
                        </MudStack>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Cost by Category</MudText>
            @if (CategoryBreakdown != null && CategoryBreakdown.Count > 0)
            {
                <MudStack Spacing="1">
                    @{ var maxCatCost = CategoryBreakdown.Max(c => c.Cost); }
                    @foreach (var cat in CategoryBreakdown)
                    {
                        var pct = maxCatCost > 0 ? (double)(cat.Cost / maxCatCost) * 100 : 0;
                        var totalPct = AnalyticsData!.TotalCost > 0 ? (double)(cat.Cost / AnalyticsData.TotalCost) * 100 : 0;
                        var isCatExpanded = _expandedCategory == cat.Name;
                        <div style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: background 0.15s;"
                             @onclick="() => { _expandedCategory = isCatExpanded ? null : cat.Name; }">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-1">
                                <span style="@($"display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; background: {cat.Color}18; font-size: 0.85rem;")">@cat.Icon</span>
                                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3; flex: 1;">@cat.Name</MudText>
                                <div style="text-align: right;">
                                    <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">$@cat.Cost.ToString("F2")</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #6b7280; font-size: 0.6rem;">@cat.Count req ¬∑ @totalPct.ToString("F0")%</MudText>
                                </div>
                                <MudIcon Icon="@(isCatExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                         Size="Size.Small" Style="color: #484f58; flex-shrink: 0;" />
                            </MudStack>
                            <div style="height: 4px; background: rgba(255,255,255,0.04); border-radius: 2px; overflow: hidden;">
                                <div style="@($"height: 100%; width: {pct:F1}%; background: {cat.Color}; border-radius: 2px; transition: width 0.3s ease;")"></div>
                            </div>
                            @if (isCatExpanded)
                            {
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.04);">
                                    <MudStack Row="true" Spacing="3" Style="margin-bottom: 8px;">
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Input" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(cat.TotalInputTokens) in
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            <MudIcon Icon="@Icons.Material.Filled.Output" Size="Size.Small" Style="vertical-align: middle; color: #484f58;" /> @FormatTokens(cat.TotalOutputTokens) out
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #8b949e;">
                                            @cat.DaysActive days active
                                        </MudText>
                                    </MudStack>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <div style="@($"background: {cat.Color}12; border: 1px solid {cat.Color}30; border-radius: 8px; padding: 6px 10px; min-width: 80px;")">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Avg/Request</MudText>
                                            <MudText Typo="Typo.body2" Style="@($"font-weight: 700; color: {cat.Color};")">$@cat.AvgCostPerRequest.ToString("F4")</MudText>
                                        </div>
                                        <div style="@($"background: {cat.Color}12; border: 1px solid {cat.Color}30; border-radius: 8px; padding: 6px 10px; min-width: 80px;")">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Daily Avg</MudText>
                                            <MudText Typo="Typo.body2" Style="@($"font-weight: 700; color: {cat.Color};")">$@cat.DailyAvg.ToString("F2")<span style="font-weight: 400; font-size: 0.7rem;">/day</span></MudText>
                                        </div>
                                        <div style="@($"background: {cat.Color}12; border: 1px solid {cat.Color}30; border-radius: 8px; padding: 6px 10px; min-width: 80px;")">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Avg Tokens/Req</MudText>
                                            <MudText Typo="Typo.body2" Style="@($"font-weight: 700; color: {cat.Color};")">@(cat.Count > 0 ? FormatTokens((cat.TotalInputTokens + cat.TotalOutputTokens) / Math.Max(1, cat.Count)) : "‚Äî")</MudText>
                                        </div>
                                        <div style="@($"background: {cat.Color}12; border: 1px solid {cat.Color}30; border-radius: 8px; padding: 6px 10px; min-width: 80px;")">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Monthly Est.</MudText>
                                            <MudText Typo="Typo.body2" Style="@($"font-weight: 700; color: {cat.Color};")">$@((cat.DailyAvg * 30).ToString("F2"))</MudText>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Row 3: Most Expensive Requests -->
<MudGrid Spacing="3" Class="mb-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #e6edf3;">Most Expensive Requests</MudText>
            @if (AnalyticsData?.TopRequests != null && AnalyticsData.TopRequests.Count > 0)
            {
                <MudStack Spacing="1">
                    @{ var rank = 0; }
                    @foreach (var req in AnalyticsData.TopRequests.Take(10))
                    {
                        rank++;
                        var currentRank = rank;
                        var rankColor = currentRank <= 3 ? "#f59e0b" : "#484f58";
                        var catColor = (req.TaskCategory ?? "") switch { "Development" => "#3b82f6", "System" => "#a855f7", "Research" => "#06b6d4", _ => "#6b7280" };
                        var isReqExpanded = _expandedRequest == currentRank;
                        var costPerInputK = req.InputTokens > 0 ? req.CostUsd * 1000m / (req.InputTokens + req.OutputTokens) : 0m;
                        var outputRatio = (req.InputTokens + req.OutputTokens) > 0 ? (double)req.OutputTokens / (req.InputTokens + req.OutputTokens) * 100 : 0;
                        <div style="background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); padding: 10px 12px; cursor: pointer; transition: background 0.15s;"
                             @onclick="() => { _expandedRequest = _expandedRequest == currentRank ? null : currentRank; }">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <div style="@($"width: 28px; height: 28px; border-radius: 8px; background: {(rank <= 3 ? "rgba(245,158,11,0.12)" : "rgba(255,255,255,0.04)")}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;")">
                                    <span style="@($"font-weight: 800; font-size: 0.75rem; color: {rankColor};")">@rank</span>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                        @if (!string.IsNullOrEmpty(req.Project))
                                        {
                                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #e6edf3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@req.Project</MudText>
                                        }
                                        @if (!string.IsNullOrEmpty(req.TaskCategory))
                                        {
                                            <span style="@($"font-size: 0.6rem; font-weight: 600; padding: 1px 6px; border-radius: 4px; background: {catColor}22; color: {catColor}; white-space: nowrap;")">@req.TaskCategory</span>
                                        }
                                    </MudStack>
                                    <MudText Typo="Typo.caption" Style="color: #6b7280; font-size: 0.65rem; margin-top: 2px;">@(DateTime.SpecifyKind(req.Timestamp, DateTimeKind.Utc).ToLocalTime().ToString("MMM d, h:mm tt"))</MudText>
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">$@req.CostUsd.ToString("F2")</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #484f58; font-size: 0.6rem;">@req.Model.Split('/').LastOrDefault()</MudText>
                                </div>
                                <MudIcon Icon="@(isReqExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                         Size="Size.Small" Style="color: #484f58; flex-shrink: 0;" />
                            </MudStack>
                            @if (isReqExpanded)
                            {
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.04);">
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                        <div style="background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Input</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #3b82f6;">@FormatTokens(req.InputTokens)</MudText>
                                        </div>
                                        <div style="background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Output</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #a855f7;">@FormatTokens(req.OutputTokens)</MudText>
                                        </div>
                                        <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Cost/1k tokens</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #f59e0b;">$@costPerInputK.ToString("F4")</MudText>
                                        </div>
                                        <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 6px 10px; min-width: 80px;">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">Output Ratio</MudText>
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #22c55e;">@outputRatio.ToString("F0")%</MudText>
                                        </div>
                                    </div>
                                    @if (req.DurationMs > 0)
                                    {
                                        <MudStack Row="true" Spacing="3">
                                            <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">
                                                ‚è±Ô∏è @(req.DurationMs >= 1000 ? $"{req.DurationMs / 1000.0:F1}s" : $"{req.DurationMs}ms") response time
                                            </MudText>
                                            @if (req.OutputTokens > 0 && req.DurationMs > 0)
                                            {
                                                <MudText Typo="Typo.caption" Style="color: #8b949e; font-size: 0.65rem;">
                                                    üìä @((req.OutputTokens / (req.DurationMs / 1000.0)).ToString("F0")) tokens/sec
                                                </MudText>
                                            }
                                        </MudStack>
                                    }
                                </div>
                            }
                        </div>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #8b949e;">No data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private CostAnalyticsSummary? AnalyticsData;
    private DashboardRoiSummary? RoiData;
    private List<OptHistoryItem>? OptHistory;
    private decimal OptTotalSaved;
    private int SelectedDays = 30;
    private List<ChartSeries> DailyCostSeries = new();
    private string[] DailyCostLabels = Array.Empty<string>();
    private double[] ModelCostData = Array.Empty<double>();
    private string[] ModelLabels = Array.Empty<string>();
    private string? _expandedProject;
    private string? _expandedHistoryItem;
    private bool _showAllHistory;
    private List<CategoryCostItem>? CategoryBreakdown;

    private string? _expandedCategory;
    private int? _expandedRequest;

    private class CategoryCostItem
    {
        public string Name { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Color { get; set; } = "";
        public decimal Cost { get; set; }
        public int Count { get; set; }
        public int TotalInputTokens { get; set; }
        public int TotalOutputTokens { get; set; }
        public decimal AvgCostPerRequest { get; set; }
        public decimal DailyAvg { get; set; }
        public int DaysActive { get; set; }
        public decimal MaxSingleRequest { get; set; }
        public decimal MinSingleRequest { get; set; }
    }

    private static readonly Dictionary<string, (string Icon, string Color)> CategoryMeta = new()
    {
        ["Development"] = ("üõ†Ô∏è", "#3b82f6"),
        ["System"] = ("‚öôÔ∏è", "#a855f7"),
        ["Research"] = ("üîç", "#06b6d4"),
        ["Communication"] = ("üí¨", "#22c55e"),
        ["BugFix"] = ("üêõ", "#ef4444"),
        ["Security"] = ("üîí", "#f59e0b"),
    };

    private static readonly string[] ChartColors = { "#3b82f6", "#22c55e", "#f59e0b", "#a855f7", "#06b6d4", "#ef4444", "#ec4899", "#8b5cf6" };
    private string GetChartColor(int idx) => ChartColors[idx % ChartColors.Length];

    private string FriendlySessionName(string? key)
    {
        if (string.IsNullOrEmpty(key)) return "Unknown";
        // Map known session key patterns to readable names
        if (key.Contains("main:main")) return "üåê Atlas (Main)";
        if (key.Contains("cron:")) return "‚è∞ " + key.Split(':').LastOrDefault() ?? key;
        if (key.Contains("isolated:")) return "üîπ " + (key.Split(':').LastOrDefault() ?? key);
        if (key.Contains("spawn:")) return "üî∏ Sub-agent";
        if (key.StartsWith("agent:")) {
            var parts = key.Split(':');
            if (parts.Length >= 3) return parts[1] == "main" ? $"üåê {parts[2]}" : $"üîπ {parts[2]}";
        }
        return key;
    }

    private static readonly string[] ProjectColors = { "#3b82f6", "#f59e0b", "#22c55e", "#a855f7", "#06b6d4", "#ef4444", "#ec4899", "#8b5cf6", "#14b8a6", "#f97316" };

    private string GetProjectColor(string project)
    {
        var idx = Math.Abs(project.GetHashCode()) % ProjectColors.Length;
        return ProjectColors[idx];
    }

    private string FormatTokens(int tokens)
    {
        if (tokens >= 1_000_000) return $"{tokens / 1_000_000.0:F1}M";
        if (tokens >= 1_000) return $"{tokens / 1_000.0:F0}k";
        return tokens.ToString();
    }

    private void ToggleProjectDetail(string project)
    {
        _expandedProject = _expandedProject == project ? null : project;
    }

    private void ToggleHistoryItem(string title)
    {
        _expandedHistoryItem = _expandedHistoryItem == title ? null : title;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalyticsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Inject area fill under the line chart ‚Äî needs delay for SVG to fully render
        await Task.Delay(500);
        try { await JS.InvokeVoidAsync("atlasCharts.addAreaFill", "dailyCostChart"); } catch { }
    }

    private async Task SelectPeriod(int days)
    {
        SelectedDays = days;
        await LoadAnalyticsAsync();
    }

    private async Task LoadAnalyticsAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync($"/api/analytics/dashboard?days={SelectedDays}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                AnalyticsData = JsonSerializer.Deserialize<CostAnalyticsSummary>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                UpdateCharts();

            // Load ROI data
            var roiResponse = await HttpClient.GetAsync($"/api/analytics/roi?days={SelectedDays}");
            if (roiResponse.IsSuccessStatusCode)
            {
                var roiJson = await roiResponse.Content.ReadAsStringAsync();
                RoiData = JsonSerializer.Deserialize<DashboardRoiSummary>(roiJson, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }

            // Load optimization history
            var histResponse = await HttpClient.GetAsync("/api/analytics/recommendation/actions");
            if (histResponse.IsSuccessStatusCode)
            {
                var histJson = await histResponse.Content.ReadAsStringAsync();
                var histData = JsonSerializer.Deserialize<OptHistoryResponse>(histJson, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                OptHistory = histData?.Actions ?? new();
                OptTotalSaved = histData?.TotalSavedAllTime ?? 0;
            }
            }
            else
            {
                Snackbar.Add("Failed to load analytics", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ActionRecommendation(string title, bool apply)
    {
        try
        {
            var payload = new { Title = title, Action = apply ? "applied" : "rejected" };
            var response = await HttpClient.PostAsJsonAsync("/api/analytics/recommendation/action", payload);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(apply ? $"Applied: {title}" : $"Rejected ‚Äî a new suggestion will replace it", apply ? Severity.Success : Severity.Info);
                await LoadAnalyticsAsync(); // Refresh to show updated state
            }
            else
            {
                Snackbar.Add("Failed to save action", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void UpdateCharts()
    {
        if (AnalyticsData == null) return;

        // Daily Cost Chart
        DailyCostSeries = new()
        {
            new ChartSeries
            {
                Name = "Daily Cost ($)",
                Data = AnalyticsData.DailyCosts.Select(d => (double)d.Cost).ToArray()
            }
        };
        DailyCostLabels = AnalyticsData.DailyCosts
            .Select(d => d.Date.ToString("MMM d"))
            .ToArray();

        // Category breakdown from top requests (individual records have more detail)
        var allRequests = AnalyticsData.TopRequests ?? new();
        // We need all usage data for categories ‚Äî use CostBySession for totals, TopRequests for per-request stats
        CategoryBreakdown = AnalyticsData.CostBySession
            .GroupBy(s => s.TaskCategory ?? "Other")
            .Select(g =>
            {
                var hasMeta = CategoryMeta.TryGetValue(g.Key, out var meta);
                var totalCost = g.Sum(s => s.TotalCost);
                var totalReqs = g.Sum(s => s.RequestCount);
                var catRequests = allRequests.Where(r => (r.TaskCategory ?? "Other") == g.Key).ToList();
                var daysActive = catRequests.Select(r => r.Timestamp.Date).Distinct().Count();
                var dailyAvg = daysActive > 0 ? totalCost / daysActive : 0;
                return new CategoryCostItem
                {
                    Name = g.Key,
                    Icon = hasMeta ? meta.Icon : "üìä",
                    Color = hasMeta ? meta.Color : "#8b949e",
                    Cost = totalCost,
                    Count = totalReqs,
                    TotalInputTokens = catRequests.Sum(r => r.InputTokens),
                    TotalOutputTokens = catRequests.Sum(r => r.OutputTokens),
                    AvgCostPerRequest = totalReqs > 0 ? totalCost / totalReqs : 0,
                    DailyAvg = dailyAvg,
                    DaysActive = daysActive,
                    MaxSingleRequest = catRequests.Any() ? catRequests.Max(r => r.CostUsd) : 0,
                    MinSingleRequest = catRequests.Any() ? catRequests.Min(r => r.CostUsd) : 0,
                };
            })
            .OrderByDescending(c => c.Cost)
            .ToList();

        // Model Cost Donut Chart
        if (AnalyticsData.CostByModel.Count > 0)
        {
            ModelCostData = AnalyticsData.CostByModel.Select(m => (double)m.TotalCost).ToArray();
            ModelLabels = AnalyticsData.CostByModel.Select(m => m.Model).ToArray();
        }
    }

    private class OptHistoryResponse
    {
        public List<OptHistoryItem> Actions { get; set; } = new();
        public decimal TotalSavedAllTime { get; set; }
        public int AppliedCount { get; set; }
        public int RejectedCount { get; set; }
    }

    private class OptHistoryItem
    {
        public string RecommendationTitle { get; set; } = "";
        public string Action { get; set; } = "";
        public string? ActionDetails { get; set; }
        public decimal? EstimatedMonthlySavings { get; set; }
        public decimal ActualSavingsSinceImplementation { get; set; }
        public int DaysSinceImplementation { get; set; }
    }
}
