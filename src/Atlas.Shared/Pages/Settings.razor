@page "/settings"
@using System.Net.Http.Json

<MudText Typo="Typo.h5" Class="mb-4" Style="font-weight: 600; color: #e6edf3;">Settings</MudText>

<MudGrid Spacing="4">
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Security" Style="color: #3b82f6;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Security</MudText>
            </MudStack>
            <MudStack Spacing="3">
                <MudSwitch T="bool" Label="Require approval for credential access" Color="Color.Primary" @bind-Value="_requireCredentialApproval" />
                <MudSwitch T="bool" Label="Require approval for financial actions" Color="Color.Primary" @bind-Value="_requireFinancialApproval" />
                <MudSwitch T="bool" Label="Enable audit logging" Color="Color.Primary" @bind-Value="_auditLogging" />
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.CardMembership" Style="color: #8b5cf6;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">License</MudText>
            </MudStack>
            <MudStack Spacing="3">
                <MudStack Spacing="1">
                    <MudText Style="font-size: 0.85rem; color: #8b949e;">Current Tier</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudChip T="string" Size="Size.Medium" 
                                 Color="@GetTierColor(_currentLicense?.Tier)" 
                                 Variant="Variant.Outlined"
                                 Text="@(_currentLicense?.Tier.ToUpper() ?? "FREE")" />
                        @if (_currentLicense?.Tier != "free" && _currentLicense?.IsValid == true)
                        {
                            <MudText Style="font-size: 0.85rem; color: #10b981;">✓ Active</MudText>
                        }
                    </MudStack>
                </MudStack>

                @if (!string.IsNullOrEmpty(_currentLicense?.Email))
                {
                    <MudStack Spacing="1">
                        <MudText Style="font-size: 0.85rem; color: #8b949e;">Licensed to</MudText>
                        <MudText Style="color: #e6edf3;">@_currentLicense.Email</MudText>
                    </MudStack>
                }

                @if (_currentLicense?.Tier != "free")
                {
                    <MudStack Spacing="1">
                        <MudText Style="font-size: 0.85rem; color: #8b949e;">Expires</MudText>
                        <MudText Style="color: #e6edf3;">
                            @_currentLicense?.ExpiresAt.ToLocalTime().ToString("MMM d, yyyy")
                            @if (_currentLicense?.DaysUntilExpiry >= 0)
                            {
                                <span style="color: #8b949e;"> (@_currentLicense.DaysUntilExpiry days remaining)</span>
                            }
                        </MudText>
                    </MudStack>
                }

                <MudStack Spacing="1">
                    <MudText Style="font-size: 0.85rem; color: #8b949e;">Unlocked Modules</MudText>
                    <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                        @if (_currentLicense?.Modules?.Count > 0)
                        {
                            @foreach (var module in _currentLicense.Modules)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" 
                                         Variant="Variant.Outlined" Text="@module" />
                            }
                        }
                        else
                        {
                            <MudText Style="font-size: 0.85rem; color: #8b949e;">Dashboard, Tasks, Activity</MudText>
                        }
                    </MudStack>
                </MudStack>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.CardMembership"
                               OnClick="() => _licenseDialogVisible = true"
                               FullWidth="true">
                        @(_currentLicense?.Tier == "free" ? "Activate License" : "Update License")
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Notifications" Style="color: #f59e0b;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Notifications</MudText>
            </MudStack>
            <MudStack Spacing="3">
                <MudSwitch T="bool" Label="Permission request alerts" Color="Color.Primary" @bind-Value="_permissionAlerts" />
                <MudSwitch T="bool" Label="Task completion notifications" Color="Color.Primary" @bind-Value="_taskNotifications" />
                <MudSwitch T="bool" Label="Cost threshold warnings" Color="Color.Primary" @bind-Value="_costWarnings" />
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.VpnKey" Style="color: #06b6d4;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Credential Vault</MudText>
            </MudStack>

            @if (_credentialsLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (_credentials.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-0">
                    No credentials stored yet.
                </MudAlert>
            }
            else
            {
                <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
                    <thead>
                        <tr>
                            <th style="color: #8b949e;">Name</th>
                            <th style="color: #8b949e;">Category</th>
                            <th style="color: #8b949e;">Vault Mode</th>
                            <th style="color: #8b949e;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cred in _credentials)
                        {
                            <tr>
                                <td style="color: #e6edf3;">@cred.Name</td>
                                <td style="color: #8b949e;">@cred.Category</td>
                                <td>
                                    @if (_credentialModes.ContainsKey(cred.Id))
                                    {
                                        var mode = _credentialModes[cred.Id];
                                        var color = mode == "unlocked" ? Color.Success : Color.Warning;
                                        var icon = mode == "unlocked" ? Icons.Material.Filled.LockOpen : Icons.Material.Filled.Lock;
                                        <MudChip T="string" Size="Size.Small" Color="@color" Variant="Variant.Outlined" 
                                                 StartIcon="@icon" Text="@(mode.ToUpper())" />
                                    }
                                </td>
                                <td>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                   Color="Color.Primary" OnClick="() => OpenVaultModeDialog(cred.Id, cred.Name)"
                                                   Title="Edit vault mode" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.PhonelinkSetup" Style="color: #10b981;" />
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Paired Devices</MudText>
                </MudStack>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.QrCode2" OnClick="ShowPairingDialog">
                    Pair New Device
                </MudButton>
            </MudStack>

            @if (_devicesLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (_devices.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-0">
                    No devices paired yet. Click "Pair New Device" to connect a mobile app.
                </MudAlert>
            }
            else
            {
                <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
                    <thead>
                        <tr>
                            <th style="color: #8b949e;">Device</th>
                            <th style="color: #8b949e;">Platform</th>
                            <th style="color: #8b949e;">Paired</th>
                            <th style="color: #8b949e;">Last Seen</th>
                            <th style="color: #8b949e;">Status</th>
                            <th style="color: #8b949e;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in _devices)
                        {
                            <tr>
                                <td style="color: #e6edf3;">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@GetDeviceIcon(device.DeviceType)" Size="Size.Small" Style="color: #8b949e;" />
                                        @device.Name
                                    </MudStack>
                                </td>
                                <td style="color: #8b949e;">@(device.Platform ?? "—")</td>
                                <td style="color: #8b949e;">@device.PairedAt.ToLocalTime().ToString("MMM d, yyyy")</td>
                                <td style="color: #8b949e;">@(device.LastSeenAt?.ToLocalTime().ToString("MMM d, h:mm tt") ?? "Never")</td>
                                <td>
                                    @if (device.IsActive)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">Connected</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Disconnected</MudChip>
                                    }
                                </td>
                                <td>
                                    @if (device.IsActive)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.LinkOff" Size="Size.Small"
                                                       Color="Color.Error" OnClick="() => DisconnectDevice(device.Id)"
                                                       Title="Disconnect device" />
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-5" Elevation="0" Style="background: #161b22; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Palette" Style="color: #a855f7;" />
                <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Appearance</MudText>
            </MudStack>
            <MudStack Spacing="3">
                <MudSwitch T="bool" Label="Dark mode" Color="Color.Primary" @bind-Value="_darkMode" />
                <MudSwitch T="bool" Label="Compact view" Color="Color.Primary" @bind-Value="_compactView" />
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudDialog @bind-Visible="_vaultModeDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.VpnKey" Style="color: #06b6d4;" />
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Edit Vault Mode</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudText Style="color: #8b949e;">
                <strong>@_editingCredentialName</strong>
            </MudText>

            <MudStack Spacing="2">
                <MudText Style="color: #8b949e; font-size: 0.9rem;">Select vault mode:</MudText>
                <MudRadioGroup T="string" SelectedOption="@_selectedVaultMode" SelectedOptionChanged="@UpdateSelectedVaultMode">
                    <MudRadio T="string" Option="@("locked")" Color="Color.Primary">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                            <MudText>Locked (requires approval)</MudText>
                        </MudStack>
                    </MudRadio>
                    <MudRadio T="string" Option="@("unlocked")" Color="Color.Primary">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.LockOpen" Size="Size.Small" />
                            <MudText>Unlocked (auto-approved, notified)</MudText>
                        </MudStack>
                    </MudRadio>
                </MudRadioGroup>
            </MudStack>

            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                @if (_selectedVaultMode == "locked")
                {
                    <MudText Style="font-size: 0.85rem; color: #8b949e;">
                        Locked mode requires explicit approval before access is granted. Owner receives a notification.
                    </MudText>
                }
                else
                {
                    <MudText Style="font-size: 0.85rem; color: #8b949e;">
                        Unlocked mode auto-grants access immediately. Owner still receives a notification of the access.
                    </MudText>
                }
            </MudAlert>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _vaultModeDialogVisible = false">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveVaultMode" Disabled="@_savingVaultMode">
            @(_savingVaultMode ? "Saving..." : "Save")
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_pairingDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.QrCode2" Style="color: #3b82f6;" />
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Pair Mobile App</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_pairingLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-6">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Style="color: #8b949e;">Generating pairing code...</MudText>
            </MudStack>
        }
        else if (_pairingData != null)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="pa-4">
                <MudText Style="color: #8b949e;" Align="Align.Center">
                    Scan this QR code with the Atlas mobile app, or enter the code manually.
                </MudText>

                @* QR Code display — rendered as a data URL from the server *@
                <MudPaper Elevation="0" Style="background: white; border-radius: 12px; padding: 16px;">
                    <img src="@_qrCodeDataUrl" alt="Pairing QR Code" style="width: 200px; height: 200px;" />
                </MudPaper>

                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Style="color: #8b949e; font-size: 0.85rem;">Or enter this code manually:</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #e6edf3; letter-spacing: 8px; font-family: monospace;">
                        @_pairingData.Code
                    </MudText>
                </MudStack>

                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true">
                    This code expires in 5 minutes.
                </MudAlert>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _pairingDialogVisible = false">Close</MudButton>
        <MudButton Color="Color.Primary" OnClick="ShowPairingDialog">Regenerate</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_licenseDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.CardMembership" Style="color: #8b5cf6;" />
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #e6edf3;">Activate License</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudText Style="color: #8b949e;">
                Enter your license key to unlock premium features.
            </MudText>

            <MudTextField T="string"
                          Label="License Key"
                          @bind-Value="_licenseKeyInput"
                          TextFieldType="TextFieldType.Password"
                          HelperText="Paste your license key here"
                          Lines="5"
                          Variant="Variant.Outlined"
                          FullWidth="true"
                          Style="color: #e6edf3;" />

            @if (!string.IsNullOrEmpty(_licenseErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true">
                    @_licenseErrorMessage
                </MudAlert>
            }

            @if (!string.IsNullOrEmpty(_licenseSuccessMessage))
            {
                <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true">
                    @_licenseSuccessMessage
                </MudAlert>
            }

            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => ClearLicense()" 
                           Disabled="@(IsFreeOrActivating())">
                    Clear License
                </MudButton>
                <MudSpacer />
                <MudLink Href="https://atlas-control-panel.com/pricing" Target="_blank">
                    Get License →
                </MudLink>
            </MudStack>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _licenseDialogVisible = false">Close</MudButton>
        <MudButton Color="Color.Primary" OnClick="ActivateLicense" Disabled="@(string.IsNullOrWhiteSpace(_licenseKeyInput) || _activatingLicense)">
            @(_activatingLicense ? "Activating..." : "Activate")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _requireCredentialApproval = true;
    private bool _requireFinancialApproval = true;
    private bool _auditLogging = true;
    private bool _permissionAlerts = true;
    private bool _taskNotifications = true;
    private bool _costWarnings = true;
    private bool _darkMode = true;
    private bool _compactView;

    // License
    private LicenseStatusDto? _currentLicense;
    private bool _licenseDialogVisible;
    private bool _activatingLicense;
    private string _licenseKeyInput = "";
    private string _licenseErrorMessage = "";
    private bool IsFreeOrActivating() => _currentLicense?.Tier == "free" || _activatingLicense;
    private string _licenseSuccessMessage = "";

    // Credential Vault
    private List<SecureCredentialDto> _credentials = new();
    private Dictionary<Guid, string> _credentialModes = new();
    private bool _credentialsLoading = true;
    private bool _vaultModeDialogVisible;
    private bool _savingVaultMode;
    private Guid _editingCredentialId;
    private string _editingCredentialName = "";
    private string _selectedVaultMode = "locked";

    // Pairing
    private List<PairedDeviceDto> _devices = new();
    private bool _devicesLoading = true;
    private bool _pairingDialogVisible;
    private bool _pairingLoading;
    private PairingDataDto? _pairingData;
    private string _qrCodeDataUrl = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadLicense();
        await LoadCredentials();
        await LoadDevices();
    }

    private HttpClient CreateClient()
    {
        var client = HttpClientFactory.CreateClient();
        client.BaseAddress = new Uri(Nav.BaseUri);
        return client;
    }

    // License Management
    private async Task LoadLicense()
    {
        try
        {
            using var client = CreateClient();
            _currentLicense = await client.GetFromJsonAsync<LicenseStatusDto>("api/license");
        }
        catch
        {
            // Default to free tier if API unavailable
            _currentLicense = new LicenseStatusDto { Tier = "free", IsValid = true };
        }
    }

    private async Task ActivateLicense()
    {
        if (string.IsNullOrWhiteSpace(_licenseKeyInput))
            return;

        _activatingLicense = true;
        _licenseErrorMessage = "";
        _licenseSuccessMessage = "";

        try
        {
            using var client = CreateClient();
            var response = await client.PostAsJsonAsync("api/license", new { licenseKey = _licenseKeyInput });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LicenseStatusDto>();
                if (result != null)
                {
                    _currentLicense = result;
                    _licenseSuccessMessage = $"License activated! Welcome, {result.Email}. Tier: {result.Tier}";
                    _licenseKeyInput = "";
                    await Task.Delay(2000);
                    _licenseDialogVisible = false;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _licenseErrorMessage = "Failed to activate license. Please check your key and try again.";
            }
        }
        catch (Exception ex)
        {
            _licenseErrorMessage = $"Error activating license: {ex.Message}";
        }
        finally
        {
            _activatingLicense = false;
        }
    }

    private async Task ClearLicense()
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Clear License",
            "This will revert to free tier. Continue?",
            yesText: "Clear", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                using var client = CreateClient();
                var response = await client.DeleteAsync("api/license");
                if (response.IsSuccessStatusCode)
                {
                    await LoadLicense();
                    Snackbar.Add("License cleared. Reverted to free tier.", Severity.Info);
                }
            }
            catch
            {
                Snackbar.Add("Failed to clear license.", Severity.Error);
            }
        }
    }

    private Color GetTierColor(string? tier) => (tier?.ToLowerInvariant()) switch
    {
        "pro" => Color.Warning,
        "team" => Color.Success,
        _ => Color.Default
    };

    private async Task LoadDevices()
    {
        _devicesLoading = true;
        try
        {
            using var client = CreateClient();
            var devices = await client.GetFromJsonAsync<List<PairedDeviceDto>>("api/pairing/devices");
            _devices = devices ?? new();
        }
        catch { /* API may be unavailable */ }
        finally
        {
            _devicesLoading = false;
        }
    }

    private async Task ShowPairingDialog()
    {
        _pairingDialogVisible = true;
        _pairingLoading = true;
        StateHasChanged();

        try
        {
            using var client = CreateClient();
            var response = await client.PostAsync("api/pairing/generate", null);
            if (response.IsSuccessStatusCode)
            {
                _pairingData = await response.Content.ReadFromJsonAsync<PairingDataDto>();
                if (_pairingData != null)
                {
                    // Generate QR code as simple SVG data URL
                    _qrCodeDataUrl = GenerateQrDataUrl(_pairingData.QrData);
                }
            }
        }
        catch { }
        finally
        {
            _pairingLoading = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectDevice(Guid id)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Disconnect Device",
            "This device will no longer be able to access the control panel. Continue?",
            yesText: "Disconnect", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                using var client = CreateClient();
                await client.DeleteAsync($"api/pairing/devices/{id}");
                Snackbar.Add("Device disconnected.", Severity.Success);
                await LoadDevices();
            }
            catch
            {
                Snackbar.Add("Failed to disconnect device.", Severity.Error);
            }
        }
    }

    private static string GetDeviceIcon(string deviceType) => deviceType switch
    {
        "mobile" => Icons.Material.Filled.PhoneAndroid,
        "desktop" => Icons.Material.Filled.DesktopWindows,
        "browser" => Icons.Material.Filled.Language,
        _ => Icons.Material.Filled.Devices
    };

    private static string GenerateQrDataUrl(string data)
    {
        using var qrGenerator = new QRCoder.QRCodeGenerator();
        using var qrCodeData = qrGenerator.CreateQrCode(data, QRCoder.QRCodeGenerator.ECCLevel.M);
        using var qrCode = new QRCoder.PngByteQRCode(qrCodeData);
        var pngBytes = qrCode.GetGraphic(8, new byte[] { 0, 0, 0 }, new byte[] { 255, 255, 255 });
        return $"data:image/png;base64,{Convert.ToBase64String(pngBytes)}";
    }

    private async Task LoadCredentials()
    {
        _credentialsLoading = true;
        _credentials.Clear();
        _credentialModes.Clear();
        try
        {
            using var client = CreateClient();
            var credentials = await client.GetFromJsonAsync<List<SecureCredentialDto>>("api/security/credentials");
            if (credentials != null)
            {
                _credentials = credentials;
                // Load vault mode for each credential
                foreach (var cred in _credentials)
                {
                    try
                    {
                        var response = await client.GetAsync($"api/security/credentials/{cred.Id}/vault-mode");
                        if (response.IsSuccessStatusCode)
                        {
                            var modeData = await response.Content.ReadFromJsonAsync<VaultModeResponseDto>();
                            if (modeData != null)
                            {
                                _credentialModes[cred.Id] = modeData.VaultMode ?? "locked";
                            }
                        }
                    }
                    catch { }
                }
            }
        }
        catch { }
        finally
        {
            _credentialsLoading = false;
        }
    }

    private void OpenVaultModeDialog(Guid credentialId, string credentialName)
    {
        _editingCredentialId = credentialId;
        _editingCredentialName = credentialName;
        _selectedVaultMode = _credentialModes.ContainsKey(credentialId) ? _credentialModes[credentialId] : "locked";
        _vaultModeDialogVisible = true;
    }

    private void UpdateSelectedVaultMode(string newMode)
    {
        _selectedVaultMode = newMode;
    }

    private async Task SaveVaultMode()
    {
        if (string.IsNullOrEmpty(_selectedVaultMode))
            return;

        _savingVaultMode = true;
        try
        {
            using var client = CreateClient();
            var response = await client.PutAsJsonAsync(
                $"api/security/credentials/{_editingCredentialId}/vault-mode",
                new { VaultMode = _selectedVaultMode });

            if (response.IsSuccessStatusCode)
            {
                _credentialModes[_editingCredentialId] = _selectedVaultMode;
                Snackbar.Add($"Vault mode updated to '{_selectedVaultMode}' for {_editingCredentialName}", Severity.Success);
                _vaultModeDialogVisible = false;
            }
            else
            {
                Snackbar.Add("Failed to update vault mode.", Severity.Error);
            }
        }
        catch
        {
            Snackbar.Add("Error updating vault mode.", Severity.Error);
        }
        finally
        {
            _savingVaultMode = false;
        }
    }

    // DTOs
    private class LicenseStatusDto
    {
        public bool IsValid { get; set; }
        public string Tier { get; set; } = "free";
        public string Email { get; set; } = "";
        public List<string> Modules { get; set; } = new();
        public DateTime IssuedAt { get; set; }
        public DateTime ExpiresAt { get; set; }
        public string LicenseId { get; set; } = "";
        public int DaysUntilExpiry { get; set; }
    }

    private class SecureCredentialDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Category { get; set; } = "";
        public string? Username { get; set; }
        public string? Description { get; set; }
        public string StorageKey { get; set; } = "********";
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
        public DateTime? LastAccessedAt { get; set; }
        public int AccessCount { get; set; }
        public string VaultMode { get; set; } = "locked";
    }

    private class VaultModeResponseDto
    {
        public string? VaultMode { get; set; }
    }

    private class PairedDeviceDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string DeviceType { get; set; } = "";
        public string? Platform { get; set; }
        public DateTime PairedAt { get; set; }
        public DateTime? LastSeenAt { get; set; }
        public string? LastIpAddress { get; set; }
        public bool IsActive { get; set; }
    }

    private class PairingDataDto
    {
        public string Code { get; set; } = "";
        public string Token { get; set; } = "";
        public string QrData { get; set; } = "";
        public string ServerUrl { get; set; } = "";
        public int ExpiresInSeconds { get; set; }
    }
}

