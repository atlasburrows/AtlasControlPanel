@using Atlas.Application.Common.Interfaces
@using Dapper
@using System.Data
@inject IDbConnectionFactory DbFactory
@implements IDisposable

<div class="sidebar-wrapper">
    <div class="profile-section">
        <MudAvatar Size="Size.Large" Style="background: #1c2333; font-size: 1.5rem; border: 2px solid #30363d;">üåê</MudAvatar>
        <MudText Typo="Typo.subtitle1" Class="mt-2" Style="font-weight: 600; color: #e6edf3;">Atlas</MudText>
        <div class="status-indicator @_statusCss">@_statusText</div>
        <MudText Typo="Typo.caption" Style="color: #8b949e;">@_statusDetail</MudText>
    </div>

    <div class="atlas-banner">
        <div class="banner-bg">
            <div class="banner-star" style="top:12%;left:18%;animation-delay:0s;"></div>
            <div class="banner-star" style="top:28%;left:72%;animation-delay:0.8s;"></div>
            <div class="banner-star" style="top:55%;left:35%;animation-delay:1.5s;"></div>
            <div class="banner-star" style="top:40%;left:85%;animation-delay:0.3s;"></div>
            <div class="banner-star" style="top:70%;left:55%;animation-delay:2.1s;"></div>
            <div class="banner-star" style="top:15%;left:50%;animation-delay:1.2s;"></div>
            <div class="banner-star" style="top:80%;left:20%;animation-delay:0.6s;"></div>
            <div class="banner-star" style="top:65%;left:80%;animation-delay:1.8s;"></div>
            <div class="banner-line" style="top:20%;left:18%;width:54%;transform:rotate(8deg);"></div>
            <div class="banner-line" style="top:45%;left:35%;width:50%;transform:rotate(-12deg);"></div>
            <div class="banner-line" style="top:60%;left:20%;width:35%;transform:rotate(5deg);"></div>
            <div class="banner-globe"></div>
        </div>
        <div class="banner-text">
            <span class="banner-tagline">Navigate. Build. Protect.</span>
        </div>
    </div>

    <div style="flex: 1;"></div>

    <MudDivider Style="border-color: rgba(255,255,255,0.06);" />

    <MudNavMenu Class="pa-2">
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
        <MudNavLink Href="/tasks" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.TaskAlt">Tasks</MudNavLink>
        <MudNavLink Href="/activity" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History">Activity</MudNavLink>
        <MudNavLink Href="/security" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Security">Security</MudNavLink>
        <MudNavLink Href="/monitoring" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.MonitorHeart">Monitoring</MudNavLink>
        <MudNavLink Href="/chat" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Chat">Chat</MudNavLink>
        <MudNavLink Href="/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
    </MudNavMenu>
</div>

@code {
    private string _statusText = "Online";
    private string _statusDetail = "Ready for tasks";
    private string _statusCss = "status-online";
    private Timer? _timer;

    protected override void OnInitialized()
    {
        _timer = new Timer(async _ => await PollStatus(), null, 0, 5000);
    }

    private async Task PollStatus()
    {
        try
        {
            using var conn = DbFactory.CreateConnection();
            var row = await conn.QuerySingleOrDefaultAsync<dynamic>("sp_SystemStatus_Get", commandType: CommandType.StoredProcedure);
            
            if (row is not null && !string.IsNullOrEmpty((string?)row.GatewayHealth))
            {
                string health = row.GatewayHealth;
                var parts = health.Split('|', 2);
                var state = parts[0].Trim();

                _statusText = state switch
                {
                    "Working" => "Working",
                    "Waiting" => "Waiting",
                    "Idle" => "Online",
                    _ => state
                };

                _statusDetail = parts.Length > 1 ? parts[1].Trim() : state switch
                {
                    "Working" => "Processing task...",
                    "Waiting" => "Rate limited",
                    "Idle" => "Ready for tasks",
                    _ => "Ready for tasks"
                };

                _statusCss = state switch
                {
                    "Working" => "status-working",
                    "Waiting" => "status-waiting",
                    _ => "status-online"
                };
            }
        }
        catch { }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose() => _timer?.Dispose();
}
